{% extends 'transactions/base.html' %}
{% load static %}

{% block title %}Reporting - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/tabs.css' %}">
<style>
    .chart-container {
        background: var(--bg-card);
        padding: 1.5rem;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        margin-top: 2rem;
        height: 400px;
        position: relative;
    }

    .filters-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
    }

    .filter-select {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="project-nav-tabs">
    <a href="{% url 'home' project.id %}" class="tab-link">
        <span class="tab-icon">üìä</span> Transactions
    </a>
    <a href="{% url 'project_reporting' project.id %}" class="tab-link active">
        <span class="tab-icon">üìà</span> Reporting
    </a>
    <a href="{% url 'project_configuration' project.id %}" class="tab-link">
        <span class="tab-icon">‚öôÔ∏è</span> Configuration
    </a>
    <a href="{% url 'project_summary' project.id %}" class="tab-link">
        <span class="tab-icon">üìù</span> Summary
    </a>
    <a href="{% url 'project_team' project.id %}" class="tab-link">
        <span class="tab-icon">üë•</span> Team
    </a>
</div>

<div class="header-row">
    <div>
        <h1 class="page-title">Reporting</h1>
        <p style="color: var(--text-muted); margin-top: -1rem;">Financial Overview</p>
    </div>
</div>

<div class="filters-row">
    <select id="daysFilter" class="filter-select" onchange="updateChart()">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 90 Days</option>
    </select>

    <select id="categoryFilter" class="filter-select" onchange="updateChart()">
        <option value="all">All Categories</option>
        <option value="beverage">Beverage</option>
        <option value="food">Food</option>
        <option value="merchandise">Merchandise</option>
        <option value="other">Other</option>
    </select>
</div>

<div class="chart-container">
    <canvas id="revenueChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chartInstance = null;

    async function fetchChartData() {
        const days = document.getElementById('daysFilter').value;
        const category = document.getElementById('categoryFilter').value;

        const response = await fetch(`{% url 'project_reporting_api' project.id %}?days=${days}&category=${category}`);
        return await response.json();
    }

    async function updateChart() {
        const data = await fetchChartData();

        const ctx = document.getElementById('revenueChart').getContext('2d');

        if (chartInstance) {
            chartInstance.destroy();
        }

        const isDark = document.body.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDark ? '#e5e7eb' : '#374151';

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Revenue ($)',
                    data: data.values,
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    }
                }
            }
        });
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', updateChart);
</script>
{% endblock %}